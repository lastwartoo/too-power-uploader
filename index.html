<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>TOO ì—°ë§¹ ì „íˆ¬ë ¥ ì—…ë¡œë“œê¸° (í…ìŠ¤íŠ¸ ë²„ì „)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      max-width: 800px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    p {
      font-size: 13px;
      color: #555;
      line-height: 1.5;
    }
    label {
      font-size: 14px;
      font-weight: 600;
    }
    input[type="number"] {
      padding: 4px 6px;
      font-size: 14px;
      width: 80px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-family: monospace;
      font-size: 13px;
      padding: 8px;
      margin-top: 4px;
    }
    button {
      margin-top: 10px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    #status {
      margin-top: 12px;
      padding: 8px;
      border-radius: 6px;
      font-size: 13px;
      white-space: pre-wrap;
    }
    #status.ok {
      background: #f0fff0;
      border: 1px solid #b3e6b3;
      color: #225522;
    }
    #status.err {
      background: #fff5f5;
      border: 1px solid #f0b3b3;
      color: #662222;
    }
  </style>
</head>
<body>
  <h1>TOO ì—°ë§¹ ì „íˆ¬ë ¥ ì—…ë¡œë“œê¸° (í…ìŠ¤íŠ¸ â†’ êµ¬ê¸€ì‹œíŠ¸)</h1>
  <p>
    â‘  ì£¼ì°¨ë¥¼ ì…ë ¥í•˜ê³ <br>
    â‘¡ ì•„ë˜ í…ìŠ¤íŠ¸ ì˜ì—­ì— <b>â€œë‹‰ë„¤ì„ ì „íˆ¬ë ¥â€</b> í˜•ì‹ìœ¼ë¡œ ì¤„ ë‹¨ìœ„ ì…ë ¥í•œ ë’¤<br>
    â‘¢ <b>[ì‹œíŠ¸ë¡œ ì „ì†¡]</b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <code>WeekData</code> ì‹œíŠ¸ì— ê¸°ë¡ë©ë‹ˆë‹¤.
  </p>
  <p>
    ì˜ˆì‹œ ì…ë ¥:<br>
    <code>
    NoT í”„ë¦¬ 168.22M<br>
    burning ê³ êµ¬ë§ˆ 164,110,000<br>
    Chrisí¬ë¦¬ìŠ¤ 160330000
    </code><br>
    â†’ ë§ˆì§€ë§‰ì— ìˆëŠ” ìˆ«ì/ìˆ«ì+M ë¶€ë¶„ì„ ìë™ìœ¼ë¡œ ì „íˆ¬ë ¥ ìˆ«ìë¡œ ë³€í™˜í•´ì„œ ë³´ëƒ„.
  </p>

  <div style="margin-top: 16px;">
    <label for="weekInput">ì£¼ì°¨</label>
    <input id="weekInput" type="number" min="1" value="1" />
  </div>

  <div style="margin-top: 10px;">
    <label for="rowsInput">ë‹‰ë„¤ì„ + ì „íˆ¬ë ¥ ì…ë ¥ (í•œ ì¤„ì— í•œ ëª…)</label><br>
    <textarea id="rowsInput" rows="10" placeholder="ì˜ˆ)&#10;NoT í”„ë¦¬ 168.22M&#10;burning ê³ êµ¬ë§ˆ 164,110,000&#10;Chrisí¬ë¦¬ìŠ¤ 160330000"></textarea>
  </div>

  <button id="sendBtn">ì‹œíŠ¸ë¡œ ì „ì†¡</button>

  <div id="status"></div>

  <script>
    // === ì—¬ê¸°ë§Œ ë„ˆ Apps Script ì›¹ì•± URLë¡œ ë³€ê²½í•˜ë©´ ë¨ ===
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyefQoXpr9jBVom4VYw07cktDW6aKyzE_vZIs-6xR6Th7e3Yl7Hosxcc9y1XuQETGQ/exec';

    // ì „íˆ¬ë ¥ ë¬¸ìì—´ â†’ ìˆ«ì (168.22M, 164,110,000, 160330000 ë“± ì²˜ë¦¬)
    function parsePower(raw) {
      if (!raw) return NaN;
      let s = raw.toString().trim();

      // 'M'ì´ë‚˜ 'm'ì´ ë¶™ì€ ê²½ìš°: 168.22M -> 168,220,000
      const mMatch = s.match(/^([0-9.,]+)\s*[mM]$/);
      if (mMatch) {
        const num = parseFloat(mMatch[1].replace(/,/g, ''));
        if (isNaN(num)) return NaN;
        return Math.round(num * 1_000_000);
      }

      // ê·¸ëƒ¥ ìˆ«ì/ì½¤ë§ˆë§Œ ìˆëŠ” ê²½ìš°
      s = s.replace(/,/g, '');
      const num2 = Number(s);
      if (isNaN(num2)) return NaN;
      return num2;
    }

    // í•œ ì¤„ íŒŒì‹±: "ë‹‰ë„¤ì„ ... ìˆ«ì/ìˆ«ìM"
    function parseLine(line) {
      const trimmed = line.trim();
      if (!trimmed) return null;

      // ëì— ìˆëŠ” "ìˆ«ì(+ì½¤ë§ˆ,ì )+M?" ì„ ì „íˆ¬ë ¥ìœ¼ë¡œ ë³´ê³  ë¶„ë¦¬
      const match = trimmed.match(/^(.*?)([0-9][0-9.,]*\s*[mM]?)$/);
      if (!match) {
        return null;
      }
      const nicknamePart = match[1].trim();
      const powerPart = match[2].trim();

      const powerNum = parsePower(powerPart);
      if (!nicknamePart || isNaN(powerNum)) {
        return null;
      }

      return {
        nickname: nicknamePart,
        power: powerNum
      };
    }

    function showStatus(msg, ok) {
      const box = document.getElementById('status');
      box.textContent = msg;
      box.className = ok ? 'ok' : 'err';
    }

        async function sendToSheet() {
      const weekValue = document.getElementById('weekInput').value;
      const text = document.getElementById('rowsInput').value;

      const week = Number(weekValue);
      if (!week || isNaN(week)) {
        showStatus('ì£¼ì°¨ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.', false);
        return;
      }

      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      if (lines.length === 0) {
        showStatus('ë‹‰ë„¤ì„/ì „íˆ¬ë ¥ì„ í•œ ì¤„ì”© ì…ë ¥í•´ ì£¼ì„¸ìš”.', false);
        return;
      }

      const rows = [];
      const invalidLines = [];

      lines.forEach((line, idx) => {
        const parsed = parseLine(line);
        if (!parsed) {
          invalidLines.push({ index: idx + 1, line });
        } else {
          rows.push(parsed);
        }
      });

      if (rows.length === 0) {
        showStatus('ìœ íš¨í•˜ê²Œ íŒŒì‹±ëœ ì¤„ì´ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.', false);
        return;
      }

      showStatus('ì‹œíŠ¸ë¡œ ì „ì†¡ ì¤‘...', true);

      try {
        // ğŸ”´ ì—¬ê¸°ë§Œ ìˆ˜ì •
        await fetch(APP_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',          // ğŸ‘‰ CORS ë‹¨ìˆœ ëª¨ë“œ
          body: JSON.stringify({
            week: week,
            rows: rows
          })
        });

        // ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì—, ê·¸ëƒ¥ "ì „ì†¡ ì‹œë„ ì™„ë£Œ"ë§Œ í‘œì‹œ
        let msg = `âœ… ì‹œíŠ¸ë¡œ ì „ì†¡ ì‹œë„ ì™„ë£Œ!\n`;
        msg += `â†’ êµ¬ê¸€ ì‹œíŠ¸ WeekData ì‹œíŠ¸ì—ì„œ ë°ì´í„°ê°€ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.\n`;

        if (invalidLines.length > 0) {
          msg += '\nâš ï¸ íŒŒì‹± ì‹¤íŒ¨í•œ ì¤„:\n';
          invalidLines.forEach(x => {
            msg += `  - ${x.index}í–‰: "${x.line}"\n`;
          });
        }

        showStatus(msg, true);

      } catch (err) {
        console.error(err);
        showStatus('ë„¤íŠ¸ì›Œí¬/ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: ' + err, false);
      }
    }
    

    document.getElementById('sendBtn').addEventListener('click', sendToSheet);
  </script>
</body>
</html>
