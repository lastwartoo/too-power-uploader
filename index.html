<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>TOO 연맹 전투력 업로드기 (텍스트 버전)</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      max-width: 800px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }
    p {
      font-size: 13px;
      color: #555;
      line-height: 1.5;
    }
    label {
      font-size: 14px;
      font-weight: 600;
    }
    input[type="number"] {
      padding: 4px 6px;
      font-size: 14px;
      width: 80px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-family: monospace;
      font-size: 13px;
      padding: 8px;
      margin-top: 4px;
    }
    button {
      margin-top: 10px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    #status {
      margin-top: 12px;
      padding: 8px;
      border-radius: 6px;
      font-size: 13px;
      white-space: pre-wrap;
    }
    #status.ok {
      background: #f0fff0;
      border: 1px solid #b3e6b3;
      color: #225522;
    }
    #status.err {
      background: #fff5f5;
      border: 1px solid #f0b3b3;
      color: #662222;
    }
  </style>
</head>
<body>
  <h1>TOO 연맹 전투력 업로드기 (텍스트 → 구글시트)</h1>
  <p>
    ① 주차를 입력하고<br>
    ② 아래 텍스트 영역에 <b>“닉네임 전투력”</b> 형식으로 줄 단위 입력한 뒤<br>
    ③ <b>[시트로 전송]</b> 버튼을 누르면 <code>WeekData</code> 시트에 기록됩니다.
  </p>
  <p>
    예시 입력:<br>
    <code>
    NoT 프리 168.22M<br>
    burning 고구마 164,110,000<br>
    Chris크리스 160330000
    </code><br>
    → 마지막에 있는 숫자/숫자+M 부분을 자동으로 전투력 숫자로 변환해서 보냄.
  </p>

  <div style="margin-top: 16px;">
    <label for="weekInput">주차</label>
    <input id="weekInput" type="number" min="1" value="1" />
  </div>

  <div style="margin-top: 10px;">
    <label for="rowsInput">닉네임 + 전투력 입력 (한 줄에 한 명)</label><br>
    <textarea id="rowsInput" rows="10" placeholder="예)&#10;NoT 프리 168.22M&#10;burning 고구마 164,110,000&#10;Chris크리스 160330000"></textarea>
  </div>

  <button id="sendBtn">시트로 전송</button>

  <div id="status"></div>

  <script>
    // === 여기만 너 Apps Script 웹앱 URL로 변경하면 됨 ===
    const APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyefQoXpr9jBVom4VYw07cktDW6aKyzE_vZIs-6xR6Th7e3Yl7Hosxcc9y1XuQETGQ/exec';

    // 전투력 문자열 → 숫자 (168.22M, 164,110,000, 160330000 등 처리)
    function parsePower(raw) {
      if (!raw) return NaN;
      let s = raw.toString().trim();

      // 'M'이나 'm'이 붙은 경우: 168.22M -> 168,220,000
      const mMatch = s.match(/^([0-9.,]+)\s*[mM]$/);
      if (mMatch) {
        const num = parseFloat(mMatch[1].replace(/,/g, ''));
        if (isNaN(num)) return NaN;
        return Math.round(num * 1_000_000);
      }

      // 그냥 숫자/콤마만 있는 경우
      s = s.replace(/,/g, '');
      const num2 = Number(s);
      if (isNaN(num2)) return NaN;
      return num2;
    }

    // 한 줄 파싱: "닉네임 ... 숫자/숫자M"
    function parseLine(line) {
      const trimmed = line.trim();
      if (!trimmed) return null;

      // 끝에 있는 "숫자(+콤마,점)+M?" 을 전투력으로 보고 분리
      const match = trimmed.match(/^(.*?)([0-9][0-9.,]*\s*[mM]?)$/);
      if (!match) {
        return null;
      }
      const nicknamePart = match[1].trim();
      const powerPart = match[2].trim();

      const powerNum = parsePower(powerPart);
      if (!nicknamePart || isNaN(powerNum)) {
        return null;
      }

      return {
        nickname: nicknamePart,
        power: powerNum
      };
    }

    function showStatus(msg, ok) {
      const box = document.getElementById('status');
      box.textContent = msg;
      box.className = ok ? 'ok' : 'err';
    }

    async function sendToSheet() {
      const weekValue = document.getElementById('weekInput').value;
      const text = document.getElementById('rowsInput').value;

      const week = Number(weekValue);
      if (!week || isNaN(week)) {
        showStatus('주차를 올바르게 입력해 주세요.', false);
        return;
      }

      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      if (lines.length === 0) {
        showStatus('닉네임/전투력을 한 줄씩 입력해 주세요.', false);
        return;
      }

      const rows = [];
      const invalidLines = [];

      lines.forEach((line, idx) => {
        const parsed = parseLine(line);
        if (!parsed) {
          invalidLines.push({ index: idx + 1, line });
        } else {
          rows.push(parsed);
        }
      });

      if (rows.length === 0) {
        showStatus('유효하게 파싱된 줄이 없습니다. 입력 형식을 확인해 주세요.', false);
        return;
      }

      showStatus('시트로 전송 중...', true);

      try {
        const res = await fetch(APP_SCRIPT_URL, {
          method: 'POST',
          // headers: { 'Content-Type': 'application/json' }, // ❌ 이 줄 삭제
          body: JSON.stringify({
            week: week,
            rows: rows
          })
        });

        const data = await res.json(); // 이건 그대로 사용

        if (!data.ok) {
          console.error(data);
          showStatus('오류 발생: ' + (data.message || '알 수 없는 오류'), false);
          return;
        }

        let msg = '';
        msg += `✅ 시트에 저장된 인원: ${data.inserted}명\n`;

        if (invalidLines.length > 0) {
          msg += '\n⚠️ 파싱 실패한 줄:\n';
          invalidLines.forEach(x => {
            msg += `  - ${x.index}행: "${x.line}"\n`;
          });
        }

        if (data.unknown && data.unknown.length > 0) {
          msg += '\n⚠️ Members에서 찾지 못한 닉네임(멤버 매칭 실패):\n';
          data.unknown.forEach(x => {
            msg += `  - ${x.nickname} (${x.power})\n`;
          });
          msg += '\n→ Members 시트의 nickname/canon_name을 확인해 주세요.';
        }

        showStatus(msg, true);

      } catch (err) {
        console.error(err);
        showStatus('네트워크/스크립트 오류: ' + err, false);
      }

    }

    document.getElementById('sendBtn').addEventListener('click', sendToSheet);
  </script>
</body>
</html>
